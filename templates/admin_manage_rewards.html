{% extends "base.html" %}
{% block title %}Manage Rewards{% endblock %}
{% block content %}
<div class="fixed inset-y-0 left-0 md:left-64 right-0 bg-gradient-to-br from-purple-400 via-pink-500 to-red-500 overflow-hidden transition-all duration-300">
  <!-- Header -->
  <div class="absolute top-16 md:top-0 left-0 right-0 bg-white shadow-lg border-b z-[60]">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 md:py-6">
      <div class="flex items-center justify-between">
        <div>
          <h1 class="text-2xl md:text-3xl font-bold bg-gradient-to-r from-purple-600 to-pink-600 bg-clip-text text-transparent">Manage Rewards</h1>
          <p class="text-gray-600 mt-1 text-sm md:text-base hidden sm:block">Create and manage reward items for students</p>
        </div>
        <div class="flex items-center space-x-4">
          <div class="bg-gradient-to-r from-purple-500 to-pink-500 rounded-full p-2 md:p-3 shadow-lg">
            <i class="fas fa-gift text-white text-lg md:text-xl"></i>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Content Area -->
  <div class="absolute top-44 md:top-24 left-0 right-0 bottom-0 md:bottom-0 overflow-y-auto pb-20 md:pb-0">
    <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 pt-6 pb-8">
    <!-- Flash Messages -->
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <div class="mb-6 p-4 rounded-xl {% if category == 'error' %}bg-red-100 text-red-700 border border-red-200{% else %}bg-green-100 text-green-700 border border-green-200{% endif %}">
                    {{ message }}
                </div>
            {% endfor %}
        {% endif %}
    {% endwith %}

    <!-- Add New Reward Form -->
    <div class="bg-white/90 backdrop-blur-sm rounded-2xl shadow-xl border border-white/20 p-6 mb-8">
        <h2 class="text-xl font-semibold text-gray-900 mb-6 flex items-center">
            <i class="fas fa-plus text-blue-600 mr-2"></i>Add New Reward
        </h2>
            
            <form method="POST" class="space-y-6">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Reward Name -->
                    <div>
                        <label for="name" class="block text-sm font-medium text-gray-700 mb-2">
                            <i class="fas fa-tag mr-2"></i>Reward Name *
                        </label>
                        <input type="text" 
                               id="name" 
                               name="name" 
                               required
                               class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-colors"
                               placeholder="e.g., 10% Canteen Discount">
                    </div>

                    <!-- Points Cost -->
                    <div>
                        <label for="points_cost" class="block text-sm font-medium text-gray-700 mb-2">
                            <i class="fas fa-coins mr-2"></i>Points Cost *
                        </label>
                        <input type="number" 
                               id="points_cost" 
                               name="points_cost" 
                               required
                               min="1"
                               class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-colors"
                               placeholder="e.g., 100">
                    </div>
                </div>

                <!-- Description -->
                <div>
                    <label for="description" class="block text-sm font-medium text-gray-700 mb-2">
                        <i class="fas fa-align-left mr-2"></i>Description
                    </label>
                    <textarea id="description" 
                              name="description"
                              rows="3"
                              class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-colors resize-none"
                              placeholder="Describe what this reward offers..."></textarea>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Reward Type -->
                    <div>
                        <label for="reward_type" class="block text-sm font-medium text-gray-700 mb-2">
                            <i class="fas fa-cog mr-2"></i>Reward Type
                        </label>
                        <select id="reward_type" 
                                name="reward_type"
                                class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-colors">
                            <option value="discount">Percentage Discount</option>
                            <option value="free_item">Free Menu Item</option>
                            <option value="cash_credit">Cash Credit</option>
                        </select>
                    </div>

                    <!-- Discount Percentage (for discount type) -->
                    <div id="discount_field">
                        <label for="discount_percentage" class="block text-sm font-medium text-gray-700 mb-2">
                            <i class="fas fa-percentage mr-2"></i>Discount Percentage
                        </label>
                        <input type="number" 
                               id="discount_percentage" 
                               name="discount_percentage"
                               min="1"
                               max="100"
                               step="0.01"
                               class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-colors"
                               placeholder="e.g., 10.00">
                    </div>

                    <!-- Menu Item (for free_item type) -->
                    <div id="menu_item_field" style="display: none;">
                        <label for="menu_item_id" class="block text-sm font-medium text-gray-700 mb-2">
                            <i class="fas fa-utensils mr-2"></i>Free Menu Item
                        </label>
                        <select id="menu_item_id" 
                                name="menu_item_id"
                                class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-colors">
                            <option value="">Select menu item...</option>
                            {% for item in menu_items %}
                                <option value="{{ item.id }}">{{ item.name }} (RM {{ item.price }})</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>

                <!-- Stock Quantity -->
                <div>
                    <label for="stock_quantity" class="block text-sm font-medium text-gray-700 mb-2">
                        <i class="fas fa-box mr-2"></i>Stock Quantity (Optional)
                    </label>
                    <input type="number" 
                           id="stock_quantity" 
                           name="stock_quantity"
                           min="1"
                           class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-colors"
                           placeholder="Leave empty for unlimited">
                    <p class="text-sm text-gray-500 mt-1">Leave empty for unlimited stock</p>
                </div>

                <!-- Submit Button -->
                <button type="submit" 
                        class="w-full bg-blue-600 hover:bg-blue-700 text-white py-3 px-6 rounded-xl font-semibold transition-colors duration-200">
                    <i class="fas fa-plus mr-2"></i>Add Reward
                </button>
            </form>
        </div>

    <!-- Existing Rewards -->
    <div class="bg-white/90 backdrop-blur-sm rounded-2xl shadow-xl border border-white/20 p-6">
        <h2 class="text-xl font-semibold text-gray-900 mb-6 flex items-center">
            <i class="fas fa-list text-blue-600 mr-2"></i>Existing Rewards
        </h2>
            
            {% if reward_items %}
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead>
                            <tr class="border-b border-gray-200">
                                <th class="text-left py-3 px-4 font-semibold text-gray-700">Name</th>
                                <th class="text-left py-3 px-4 font-semibold text-gray-700">Type</th>
                                <th class="text-left py-3 px-4 font-semibold text-gray-700">Points Cost</th>
                                <th class="text-left py-3 px-4 font-semibold text-gray-700">Value</th>
                                <th class="text-left py-3 px-4 font-semibold text-gray-700">Stock</th>
                                <th class="text-left py-3 px-4 font-semibold text-gray-700">Status</th>
                                <th class="text-left py-3 px-4 font-semibold text-gray-700">Created</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for reward in reward_items %}
                            <tr class="border-b border-gray-100">
                                <td class="py-3 px-4">
                                    <div>
                                        <h4 class="font-semibold text-gray-800">{{ reward.name }}</h4>
                                        {% if reward.description %}
                                            <p class="text-sm text-gray-600">{{ reward.description }}</p>
                                        {% endif %}
                                    </div>
                                </td>
                                <td class="py-3 px-4">
                                    <span class="px-2 py-1 rounded-full text-xs font-semibold 
                                        {% if reward.reward_type == 'discount' %}bg-blue-100 text-blue-800
                                        {% elif reward.reward_type == 'free_item' %}bg-green-100 text-green-800
                                        {% else %}bg-purple-100 text-purple-800{% endif %}">
                                        {{ reward.reward_type.replace('_', ' ').title() }}
                                    </span>
                                </td>
                                <td class="py-3 px-4 font-semibold text-blue-600">{{ reward.points_cost }}</td>
                                <td class="py-3 px-4">
                                    {% if reward.reward_type == 'discount' and reward.discount_percentage %}
                                        {{ reward.discount_percentage }}%
                                    {% elif reward.reward_type == 'free_item' and reward.menu_item %}
                                        {{ reward.menu_item.name }}
                                    {% else %}
                                        N/A
                                    {% endif %}
                                </td>
                                <td class="py-3 px-4">
                                    {% if reward.stock_quantity is not none %}
                                        <span class="{% if reward.stock_quantity > 0 %}text-green-600{% else %}text-red-600{% endif %}">
                                            {{ reward.stock_quantity }}
                                        </span>
                                    {% else %}
                                        <span class="text-gray-500">Unlimited</span>
                                    {% endif %}
                                </td>
                                <td class="py-3 px-4">
                                    <span class="px-2 py-1 rounded-full text-xs font-semibold 
                                        {% if reward.is_active %}bg-green-100 text-green-800{% else %}bg-red-100 text-red-800{% endif %}">
                                        {{ 'Active' if reward.is_active else 'Inactive' }}
                                    </span>
                                </td>
                                <td class="py-3 px-4 text-gray-600">{{ reward.created_at.strftime('%d/%m/%Y') }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
        {% else %}
            <div class="text-center py-12">
                <div class="bg-gray-100 rounded-full w-16 h-16 flex items-center justify-center mx-auto mb-4">
                    <i class="fas fa-gift text-gray-400 text-2xl"></i>
                </div>
                <h3 class="text-lg font-medium text-gray-900 mb-2">No Rewards Created</h3>
                <p class="text-gray-600">Create your first reward using the form above.</p>
            </div>
        {% endif %}
    </div>
    </div>
  </div>
</div>

<script>
    // Show/hide fields based on reward type
    document.getElementById('reward_type').addEventListener('change', function() {
        const rewardType = this.value;
        const discountField = document.getElementById('discount_field');
        const menuItemField = document.getElementById('menu_item_field');
        
        if (rewardType === 'discount') {
            discountField.style.display = 'block';
            menuItemField.style.display = 'none';
        } else if (rewardType === 'free_item') {
            discountField.style.display = 'none';
            menuItemField.style.display = 'block';
        } else {
            discountField.style.display = 'none';
            menuItemField.style.display = 'none';
        }
    });
</script>
  </div>
</div>
{% endblock %}
