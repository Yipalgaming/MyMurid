{% extends "base.html" %}
{% block title %}Manage Students{% endblock %}
{% block content %}
<div class="fixed inset-y-0 left-0 md:left-64 right-0 bg-gradient-to-br from-blue-400 via-indigo-500 to-purple-500 overflow-hidden">
  <!-- Header -->
  <div class="absolute top-0 left-0 right-0 bg-white shadow-lg border-b z-10">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
      <div class="flex items-center justify-between">
        <div>
          <h1 class="text-3xl font-bold bg-gradient-to-r from-blue-600 to-indigo-600 bg-clip-text text-transparent">Manage Students</h1>
          <p class="text-gray-600 mt-1">Add and manage student accounts</p>
        </div>
        <div class="flex items-center space-x-4">
          <div class="bg-gradient-to-r from-blue-500 to-indigo-500 rounded-full p-3 shadow-lg">
            <i class="fas fa-users text-white text-xl"></i>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Content Area -->
  <div class="absolute top-24 left-0 right-0 bottom-0 md:bottom-0 overflow-y-auto pb-20 md:pb-0">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 pt-12 md:pt-8 pb-8">
    <!-- Add New Student Form -->
    <div class="bg-white rounded-2xl shadow-xl border border-gray-200 p-8 mb-8">
      <h2 class="text-2xl font-bold text-gray-900 mb-6 flex items-center">
        <i class="fas fa-user-plus text-blue-600 mr-2"></i>Add New Student
      </h2>
      
      <form method="POST" action="{{ url_for('add_student') }}" class="space-y-6">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div>
            <label for="name" class="block text-sm font-medium text-gray-700 mb-2">Full Name</label>
            <input type="text" 
                   class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-colors" 
                   id="name" 
                   name="name" 
                   placeholder="Enter student's full name"
                   required>
          </div>
          
          <div>
            <label for="ic_number" class="block text-sm font-medium text-gray-700 mb-2">IC Number (4 digits)</label>
            <input type="text" 
                   class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-colors" 
                   id="ic_number" 
                   name="ic_number" 
                   pattern="[0-9]{4}" 
                   maxlength="4" 
                   placeholder="Enter 4-digit IC"
                   required>
          </div>
        </div>
        
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
          <div>
            <label for="pin" class="block text-sm font-medium text-gray-700 mb-2">PIN (4 digits)</label>
            <input type="text" 
                   class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-colors" 
                   id="pin" 
                   name="pin" 
                   pattern="[0-9]{4}" 
                   maxlength="4" 
                   placeholder="Enter 4-digit PIN"
                   required>
          </div>
          
          <div>
            <label for="role" class="block text-sm font-medium text-gray-700 mb-2">Role</label>
            <select class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-colors" 
                    id="role" 
                    name="role" 
                    required>
              <option value="student">Student</option>
              <option value="staff">Staff</option>
              <option value="admin">Admin</option>
            </select>
          </div>
          
          <div>
            <label for="balance" class="block text-sm font-medium text-gray-700 mb-2">Initial Balance (RM)</label>
            <input type="number" 
                   class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-colors" 
                   id="balance" 
                   name="balance" 
                   min="0" 
                   value="0" 
                   placeholder="Enter initial balance"
                   required>
          </div>
        </div>
        
        <div id="password_group" class="hidden">
          <label for="password" class="block text-sm font-medium text-gray-700 mb-2">Password (for admin/staff)</label>
          <input type="password" 
                 class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-colors" 
                 id="password" 
                 name="password"
                 placeholder="Enter password">
        </div>
        
        <button type="submit" 
                class="w-full bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-700 hover:to-indigo-700 text-white py-3 px-6 rounded-xl font-semibold transition-all duration-300 transform hover:scale-105 shadow-lg hover:shadow-xl">
          <i class="fas fa-plus mr-2"></i>Add Student
        </button>
      </form>
    </div>
    
    <!-- Existing Students List -->
    <div class="bg-white rounded-2xl shadow-xl border border-gray-200 overflow-hidden">
      <div class="bg-gradient-to-r from-blue-500 to-indigo-500 text-white p-6">
        <h2 class="text-2xl font-bold flex items-center">
          <i class="fas fa-list mr-2"></i>Existing Students
        </h2>
      </div>
      
      <div class="overflow-x-auto">
        <table class="w-full">
          <thead class="bg-gray-50">
            <tr>
              <th class="px-6 py-4 text-left font-semibold text-gray-700">Name</th>
              <th class="px-6 py-4 text-left font-semibold text-gray-700">IC Number</th>
              <th class="px-6 py-4 text-left font-semibold text-gray-700">Role</th>
              <th class="px-6 py-4 text-left font-semibold text-gray-700">Balance</th>
              <th class="px-6 py-4 text-left font-semibold text-gray-700">Status</th>
              <th class="px-6 py-4 text-left font-semibold text-gray-700">Actions</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-gray-200">
            {% for student in students %}
            <tr class="hover:bg-gray-50 transition-colors">
              <td class="px-6 py-4 font-medium text-gray-900">{{ student.name }}</td>
              <td class="px-6 py-4 text-gray-600">{{ student.ic_number }}</td>
              <td class="px-6 py-4">
                <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium 
                  {% if student.role == 'admin' %}bg-red-100 text-red-800
                  {% elif student.role == 'staff' %}bg-yellow-100 text-yellow-800
                  {% else %}bg-blue-100 text-blue-800{% endif %}">
                  {{ student.role|title }}
                </span>
              </td>
              <td class="px-6 py-4 font-semibold text-green-600">RM {{ student.balance }}</td>
              <td class="px-6 py-4">
                <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium 
                  {% if student.frozen %}bg-red-100 text-red-800{% else %}bg-green-100 text-green-800{% endif %}">
                  {% if student.frozen %}Frozen{% else %}Active{% endif %}
                </span>
              </td>
              <td class="px-6 py-4">
                <div class="flex space-x-2">
                  <button class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded-lg text-sm font-medium transition-colors" 
                          onclick="editStudent({{ student.id }})">
                    <i class="fas fa-edit mr-1"></i>Edit
                  </button>
                  <button class="{% if student.frozen %}bg-green-500 hover:bg-green-600{% else %}bg-yellow-500 hover:bg-yellow-600{% endif %} text-white px-3 py-1 rounded-lg text-sm font-medium transition-colors" 
                          onclick="toggleStatus({{ student.id }}, '{{ student.ic_number|e }}', {{ student.frozen|lower }})">
                    {% if student.frozen %}<i class="fas fa-unlock mr-1"></i>Unfreeze{% else %}<i class="fas fa-lock mr-1"></i>Freeze{% endif %}
                  </button>
                </div>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<script>
// Show/hide password field based on role
document.getElementById('role').addEventListener('change', function() {
    const passwordGroup = document.getElementById('password_group');
    const passwordInput = document.getElementById('password');
    
    if (this.value === 'admin' || this.value === 'staff') {
        passwordGroup.style.display = 'block';
        passwordInput.required = true;
    } else {
        passwordGroup.style.display = 'none';
        passwordInput.required = false;
        passwordInput.value = '';
    }
});

function editStudent(studentId) {
    // You can implement edit functionality here
    alert('Edit functionality can be added - for now, use the database script method');
}

function toggleStatus(studentId, icNumber, isFrozen) {
    const action = isFrozen ? 'unfreeze' : 'freeze';
    const actionText = isFrozen ? 'unfreeze' : 'freeze';
    
    if (confirm(`Are you sure you want to ${actionText} this student's card?`)) {
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '{{ url_for("toggle_card_status") }}';
        
        // Add CSRF token
        const csrfInput = document.createElement('input');
        csrfInput.type = 'hidden';
        csrfInput.name = 'csrf_token';
        csrfInput.value = '{{ csrf_token() }}';
        
        const icInput = document.createElement('input');
        icInput.type = 'hidden';
        icInput.name = 'ic';
        icInput.value = icNumber;
        
        const actionInput = document.createElement('input');
        actionInput.type = 'hidden';
        actionInput.name = 'action';
        actionInput.value = action;
        
        form.appendChild(csrfInput);
        form.appendChild(icInput);
        form.appendChild(actionInput);
        document.body.appendChild(form);
        form.submit();
    }
}
</script>
{% endblock %}
