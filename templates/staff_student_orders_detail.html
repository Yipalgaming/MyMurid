{% extends "base.html" %}
{% block title %}Counter Order - {{ student.name }}{% endblock %}
{% block content %}
<div class="fixed inset-y-0 left-0 md:left-64 right-0 bg-gradient-to-br from-teal-400 via-emerald-500 to-cyan-500 overflow-hidden transition-all duration-300">
  <!-- Mobile Top Nav -->
  <nav class="absolute top-0 w-full bg-white border-b border-gray-200 z-50 shadow-md md:hidden transition-all duration-300">
    <div class="flex items-center justify-between h-16 px-4">
      <button onclick="toggleSidebar()" class="text-gray-600 hover:text-indigo-600 transition-colors p-2">
        <i class="fas fa-bars text-2xl"></i>
      </button>
      <h1 class="text-lg font-semibold text-gray-800">MyMurid</h1>
      <div class="w-10"></div>
    </div>
  </nav>

  <!-- Header -->
  <div class="absolute top-16 md:top-0 w-full bg-white shadow-lg border-b z-10">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 md:py-6">
      <div class="flex items-center justify-between">
        <div>
          <h1 class="text-2xl md:text-3xl font-bold bg-gradient-to-r from-teal-600 to-emerald-600 bg-clip-text text-transparent">
            Counter Order for {{ student.name }}
          </h1>
          <p class="text-gray-600 mt-1 text-sm md:text-base hidden sm:block">
            Add food items for this student and pay immediately from their wallet.
          </p>
        </div>
        <div class="flex items-center space-x-4">
          <div class="bg-gradient-to-r from-teal-500 to-emerald-500 rounded-full p-3 shadow-lg">
            <i class="fas fa-user-graduate text-white text-xl"></i>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Content Area -->
  <div class="absolute top-52 md:top-28 left-0 right-0 bottom-0 overflow-y-auto pb-20">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 pt-4 pb-10">
      <!-- Student summary -->
      <div class="bg-white/95 backdrop-blur-sm rounded-2xl shadow-xl border border-white/20 p-5 md:p-6 mb-6 flex flex-col md:flex-row md:items-center md:justify-between gap-4">
        <div class="flex items-center gap-4">
          <div class="bg-gradient-to-r from-teal-400 to-emerald-400 rounded-full w-12 h-12 flex items-center justify-center">
            <i class="fas fa-user text-white"></i>
          </div>
          <div>
            <div class="font-bold text-lg text-gray-900">{{ student.name }}</div>
            <div class="text-sm text-gray-600">IC: {{ student.ic_number }}</div>
          </div>
        </div>
        <div class="text-right space-y-1">
          <div class="text-sm text-gray-600">
            Wallet Balance:
            <span class="font-bold text-indigo-700">RM {{ "%.2f"|format(user_balance or 0) }}</span>
          </div>
          <div class="text-xs text-gray-500">
            This payment will be deducted from the student's wallet balance.
          </div>
        </div>
      </div>

      <!-- Order form -->
      <form method="POST" action="{{ url_for('staff_student_orders_detail', student_id=student.id) }}" id="counter-order-form">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>

        <div class="bg-white/95 backdrop-blur-sm rounded-2xl shadow-xl border border-white/20 p-5 md:p-6">
          <div class="flex flex-col lg:flex-row lg:items-start lg:space-x-6 space-y-6 lg:space-y-0">
            <!-- Menu list -->
            <div class="flex-1">
              <div class="flex items-center justify-between mb-4">
                <h2 class="text-xl font-semibold text-gray-900 flex items-center">
                  <i class="fas fa-utensils text-teal-600 mr-2"></i>
                  Menu Items
                </h2>
                <a href="{{ url_for('staff_student_orders') }}" class="text-sm text-teal-700 hover:text-teal-900 font-medium">
                  <i class="fas fa-arrow-left mr-1"></i>
                  Back to student search
                </a>
              </div>

              {% if items %}
              <div class="space-y-4">
                {% for item in items %}
                <div class="w-full bg-white rounded-2xl shadow-lg border border-gray-200 p-4 flex flex-col justify-between">
                  <div>
                    <div class="flex items-center justify-between mb-1">
                      <h3 class="font-semibold text-gray-900 text-sm md:text-base">{{ item.name }}</h3>
                      <span class="text-sm font-semibold text-emerald-700">
                        RM {{ "%.2f"|format(item.price) }}
                      </span>
                    </div>
                    {% if item.description %}
                    <p class="text-xs text-gray-600 mb-2 line-clamp-2">{{ item.description }}</p>
                    {% endif %}
                  </div>
                  <div class="mt-3 flex items-center justify-between">
                    <span class="text-xs text-gray-600 mr-2">Quantity</span>
                    <div class="flex items-center space-x-2">
                      <button
                        type="button"
                        class="w-8 h-8 flex items-center justify-center rounded-full bg-white border border-gray-300 text-gray-700 hover:bg-gray-50"
                        onclick="changeItemQuantity(event, {{ item.id }}, -1)"
                      >
                        <i class="fas fa-minus text-xs"></i>
                      </button>
                      <span id="qty_display_{{ item.id }}" class="min-w-[2rem] text-center text-sm font-semibold text-gray-800">0</span>
                      <button
                        type="button"
                        class="w-8 h-8 flex items-center justify-center rounded-full bg-emerald-500 text-white hover:bg-emerald-600"
                        onclick="changeItemQuantity(event, {{ item.id }}, 1)"
                      >
                        <i class="fas fa-plus text-xs"></i>
                      </button>
                    </div>
                  </div>
                  <input
                    type="hidden"
                    id="qty_input_{{ item.id }}"
                    name="qty_{{ item.id }}"
                    value="0"
                    data-price="{{ item.price }}"
                    data-name="{{ item.name }}"
                  >
                </div>
                {% endfor %}
              </div>
              {% else %}
              <p class="text-sm text-gray-500">No available menu items.</p>
              {% endif %}
            </div>

            <!-- Order summary -->
            <div class="w-full lg:w-80 bg-gray-50 rounded-xl border border-gray-200 p-4 flex flex-col justify-between">
              <div>
                <h3 class="text-lg font-semibold text-gray-900 mb-3 flex items-center">
                  <i class="fas fa-clipboard-list text-teal-600 mr-2"></i>
                  Current Order
                </h3>
                <div id="order-summary-items" class="space-y-2 max-h-64 overflow-y-auto text-sm text-gray-700">
                  <p class="text-gray-500 text-sm">No items selected yet.</p>
                </div>
              </div>
              <div class="border-t border-gray-200 mt-4 pt-3 space-y-2">
                <div class="flex items-center justify-between text-sm text-gray-700">
                  <span>Estimated total:</span>
                  <span id="estimated-total" class="font-bold text-emerald-700">RM 0.00</span>
                </div>
                <button
                  type="submit"
                  class="w-full bg-gradient-to-r from-emerald-500 to-teal-500 hover:from-emerald-600 hover:to-teal-600 text-white px-4 py-2.5 rounded-xl text-sm font-semibold transition-all duration-300 transform hover:scale-105 shadow-lg"
                  onclick="return confirm('Confirm payment from wallet for {{ student.name }}?');"
                >
                  <i class="fas fa-check-circle mr-2"></i>
                  Pay Now (Create Order & Charge Wallet)
                </button>
              </div>
            </div>
          </div>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
function updateEstimatedTotal() {
  let total = 0;
  const summaryItems = [];

  document.querySelectorAll('#counter-order-form input[type="hidden"][name^="qty_"]').forEach(function (input) {
    const qty = Number.parseInt(input.value || '0', 10);
    const price = Number.parseFloat(input.dataset.price || '0');
    const name = input.dataset.name || 'Item';
    if (!Number.isNaN(qty) && qty > 0 && !Number.isNaN(price)) {
      const lineTotal = qty * price;
      total += lineTotal;
      summaryItems.push({
        name,
        qty,
        price,
        lineTotal
      });
    }
  });

  const totalEl = document.getElementById('estimated-total');
  if (totalEl) {
    totalEl.textContent = 'RM ' + total.toFixed(2);
  }

  const summaryEl = document.getElementById('order-summary-items');
  if (summaryEl) {
    if (summaryItems.length === 0) {
      summaryEl.innerHTML = '<p class="text-gray-500 text-sm">No items selected yet.</p>';
    } else {
      summaryEl.innerHTML = summaryItems.map(function (item) {
        return `
          <div class="flex items-center justify-between">
            <div>
              <div class="font-medium text-gray-900">${item.name}</div>
              <div class="text-xs text-gray-600">${item.qty} Ã— RM ${item.price.toFixed(2)}</div>
            </div>
            <div class="text-sm font-semibold text-emerald-700">RM ${item.lineTotal.toFixed(2)}</div>
          </div>
        `;
      }).join('');
    }
  }
}

function changeItemQuantity(event, itemId, delta) {
  if (event && event.stopPropagation) {
    event.stopPropagation();
  }
  const input = document.getElementById('qty_input_' + itemId);
  const display = document.getElementById('qty_display_' + itemId);
  if (!input || !display) return;

  const current = Number.parseInt(input.value || '0', 10);
  let next = current + delta;
  if (next < 0) next = 0;

  input.value = String(next);
  display.textContent = String(next);

  updateEstimatedTotal();
}

document.addEventListener('DOMContentLoaded', function () {
  updateEstimatedTotal();
});
</script>
{% endblock %}

