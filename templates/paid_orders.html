{% extends "base.html" %}
{% block title %}Paid Orders{% endblock %}
{% block content %}
<div class="fixed inset-y-0 left-0 md:left-64 right-0 bg-gradient-to-br from-orange-400 via-red-500 to-pink-500 overflow-hidden">
  <!-- Header -->
  <div class="absolute top-0 left-0 right-0 bg-white shadow-lg border-b z-10">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
      <div class="flex items-center justify-between">
        <div>
          <h1 class="text-3xl font-bold bg-gradient-to-r from-orange-600 to-red-600 bg-clip-text text-transparent">Paid Orders</h1>
          <p class="text-gray-600 mt-1">Manage and track order fulfillment</p>
        </div>
        <div class="flex items-center space-x-4">
          <div class="bg-gradient-to-r from-orange-500 to-red-500 rounded-full p-3 shadow-lg">
            <i class="fas fa-box text-white text-xl"></i>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Content Area -->
  <div class="absolute top-24 left-0 right-0 bottom-0 overflow-y-auto">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <!-- Filter Toggle -->
    <div class="bg-white rounded-2xl shadow-xl border border-white/20 p-6 mb-8">
      <div class="flex items-center justify-between">
        <h2 class="text-xl font-semibold text-gray-900 flex items-center">
          <i class="fas fa-filter text-orange-600 mr-2"></i>
          Order Filter
        </h2>
        <div class="flex items-center space-x-3">
          <label class="flex items-center cursor-pointer">
            <input type="checkbox" id="toggleDone" onchange="toggleDoneRows()" class="sr-only">
            <div class="relative">
              <div class="w-12 h-6 bg-gray-300 rounded-full shadow-inner transition-colors duration-300" id="toggle-bg"></div>
              <div class="absolute top-0 left-0 w-6 h-6 bg-white rounded-full shadow transform transition-transform duration-300" id="toggle-knob"></div>
            </div>
            <span class="ml-3 text-gray-700 font-medium">Show Completed Orders</span>
          </label>
        </div>
      </div>
</div>

      <!-- Orders Table -->
      <div class="bg-white rounded-2xl shadow-xl border border-white/20 overflow-hidden">
      <div class="overflow-x-auto">
        <table class="w-full">
          <thead class="bg-gradient-to-r from-orange-500 to-red-500 text-white">
            <tr>
              <th class="px-6 py-4 text-left font-semibold">Student</th>
              <th class="px-6 py-4 text-left font-semibold">Order Details</th>
              <th class="px-6 py-4 text-left font-semibold">Status</th>
              <th class="px-6 py-4 text-left font-semibold">Actions</th>
    </tr>
  </thead>
          <tbody class="divide-y divide-gray-200">
    {% for student, orders in grouped_orders.items() %}
      {% for order in orders %}
              <tr class="{% if order.status == 'completed' %}done-row bg-gray-50{% else %}hover:bg-gray-50{% endif %} transition-colors">
                <td class="px-6 py-4">
                  <div class="flex items-center">
                    <div class="bg-gradient-to-r from-orange-400 to-red-400 rounded-full w-10 h-10 flex items-center justify-center mr-3">
                      <i class="fas fa-user text-white text-sm"></i>
                    </div>
                    <div>
                      <div class="font-semibold text-gray-900">{{ student.name }}</div>
                      <div class="text-sm text-gray-500">ID: {{ student.id }}</div>
                    </div>
                  </div>
                </td>
                <td class="px-6 py-4">
                  <div class="flex items-center">
                    <div class="bg-gray-100 rounded-lg p-2 mr-3">
                      <i class="fas fa-utensils text-gray-600"></i>
                    </div>
                    <div>
                      <div class="font-medium text-gray-900">{{ order.item.name }}</div>
                      <div class="text-sm text-gray-500">Quantity: {{ order.quantity }}</div>
                      <div class="text-sm text-green-600 font-semibold">RM {{ "%.2f"|format(order.item.price * order.quantity) }}</div>
                    </div>
                  </div>
                </td>
                <td class="px-6 py-4">
                  {% if order.status == 'completed' %}
                    <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-green-100 text-green-800">
                      <i class="fas fa-check-circle mr-1"></i>
                      Completed
                    </span>
          {% else %}
                    <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-yellow-100 text-yellow-800">
                      <i class="fas fa-clock mr-1"></i>
                      Pending
                    </span>
          {% endif %}
        </td>
                <td class="px-6 py-4">
                  <div class="flex space-x-2">
                    {% if order.status != 'completed' %}
                    <button class="bg-gradient-to-r from-green-500 to-emerald-500 hover:from-green-600 hover:to-emerald-600 text-white px-4 py-2 rounded-lg text-sm font-medium transition-all duration-300 transform hover:scale-105 shadow-lg hover:shadow-xl" 
                            onclick="markDone({{ order.id }}, this)">
                      <i class="fas fa-check mr-1"></i>
                      Mark Done
                    </button>
          {% endif %}

          {% if current_user.role == "admin" %}
                    <button class="bg-gradient-to-r from-red-500 to-pink-500 hover:from-red-600 hover:to-pink-600 text-white px-4 py-2 rounded-lg text-sm font-medium transition-all duration-300 transform hover:scale-105 shadow-lg hover:shadow-xl" 
                            onclick="deleteOrder({{ order.id }}, this)">
                      <i class="fas fa-trash mr-1"></i>
                      Delete
                    </button>
          {% endif %}
                  </div>
        </td>
      </tr>
      {% endfor %}
    {% endfor %}
  </tbody>
</table>
      </div>
    </div>

    <!-- Empty State -->
    {% if not grouped_orders %}
    <div class="bg-white/90 backdrop-blur-sm rounded-2xl shadow-xl border border-white/20 p-12 text-center">
      <div class="bg-gray-100 rounded-full w-16 h-16 flex items-center justify-center mx-auto mb-4">
        <i class="fas fa-box-open text-gray-400 text-2xl"></i>
      </div>
      <h3 class="text-xl font-semibold text-gray-900 mb-2">No Orders Found</h3>
      <p class="text-gray-600">There are no paid orders to display at the moment.</p>
    </div>
    {% endif %}
  </div>
</div>

<script>
function toggleDoneRows() {
  const checkbox = document.getElementById('toggleDone');
  const toggleBg = document.getElementById('toggle-bg');
  const toggleKnob = document.getElementById('toggle-knob');
  const rows = document.querySelectorAll('.done-row');
  
  if (checkbox.checked) {
    toggleBg.classList.remove('bg-gray-300');
    toggleBg.classList.add('bg-green-500');
    toggleKnob.classList.add('translate-x-6');
    rows.forEach(row => row.style.display = 'table-row');
  } else {
    toggleBg.classList.remove('bg-green-500');
    toggleBg.classList.add('bg-gray-300');
    toggleKnob.classList.remove('translate-x-6');
    rows.forEach(row => row.style.display = 'none');
  }
}

function markDone(orderId, button) {
  fetch('/mark-done', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({ order_id: orderId })
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      // Update button to show completed state
      button.innerHTML = '<i class="fas fa-check mr-1"></i>Completed';
      button.classList.remove('bg-gradient-to-r', 'from-green-500', 'to-emerald-500', 'hover:from-green-600', 'hover:to-emerald-600');
      button.classList.add('bg-gray-400', 'cursor-not-allowed');
      button.disabled = true;
      
      // Update status badge
      const row = button.closest('tr');
      const statusCell = row.querySelector('td:nth-child(3)');
      statusCell.innerHTML = '<span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-green-100 text-green-800"><i class="fas fa-check-circle mr-1"></i>Completed</span>';
      
      // Add completed styling
      row.classList.add('done-row', 'bg-gray-50');
    }
  })
  .catch(error => {
    console.error('Error:', error);
    alert('Failed to mark order as done');
  });
}

function deleteOrder(orderId, button) {
  if (confirm('Are you sure you want to delete this order?')) {
    fetch('/delete-order', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({ order_id: orderId })
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        button.closest('tr').remove();
      }
    })
    .catch(error => {
      console.error('Error:', error);
      alert('Failed to delete order');
    });
  }
}
</script>

<style>
.done-row {
  opacity: 0.7;
}

.animation-delay-2000 {
  animation-delay: 2s;
}

.animation-delay-4000 {
  animation-delay: 4s;
}
</style>
{% endblock %}
